{% load staticfiles %}
{% load my_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

	<title>minus.lviv.ua</title>
	<!-- Materialize -->
	<link rel="stylesheet" href="{% static 'materialize/css/materialize.min.css' %}">

	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<!-- mycss -->
<link rel="stylesheet" href="{% static 'css/style.css' %}">
	<link rel="stylesheet" href="{% static 'css/messanger.css' %}">
</head>
<body>

<div class="father_GOD">

<div class="container-fluid">
	<div class="row">

<!-- TODO this will be rewriten because Nu yogo nahuy cey gavnocodische->
<!-- Ліва паннель  -->

<section class="col s12">
	<div class="row">
		<nav>
			<a href="#" data-target="slide-out" class="sidenav-trigger"  style="color:#6baf00;text-align:center;"><i class="material-icons">menu</i></a>
			{% if recipient %}<p class="right-align username">{% if recipient.first_name or recipient.last_name %}{{ recipient.first_name}} {{ recipient.last_name }}{% else %}{{ recipient.username }} {% endif %}</p>{% endif %}
		<div class="col s5 l3 sender nav-content hide-on-med-and-down">

	    	<ul class="collection hide-on-med-and-down" >

	    		<li id="search_field" class="collection-item l3">

					<div class="row">
					    <div class="col s12">
					      <div class="row">
									<form  action="{% url 'search' %}" method="GET">
					        <div class="input-field col s12">
					          <i class="material-icons prefix">search</i>

											<input type="text" id="autocomplete-input" class="autocomplete" name="search">
						          <label for="autocomplete-input">Пошук користувача</label>
											<input type="submit" style="display:none;">

					        </div>
									</form>
					      </div>
					    </div>
				  	</div>

					</li>

					<!-- {% endif %}  -->
					{% for s in sender %}

						{% if s.id == pk %}

						<li class="collection-item avatar l3 tab" style="background-color:red;">
		    				<a class="hidden_a" href="{% url 'message_user' pk=s.id %}"  style='background-color:#66baf00;' >
							<!-- <span -->
						{% else %}
							{% if recipient.id == s.id %}

								<li class="collection-item avatar l3 tab" style="background-color:greenyellow;">
							{% else %}
								<li class="collection-item avatar l3 tab" >
							{% endif %}
								<a class="hidden_a  l{{ s.id }}" href="{% url 'message_user' pk=s.id %}"  >
						{% endif %}
								<span style="display: none;" class="id" data-id="{{ s.id }}"></span>

								{% load my_tags %}
									<img src="/static/{% avatar pk=s.pk %}"   alt="" class="circle">
			      					<p class="title">{% if s.first_name %}{{ s.first_name }} {{ s.last_name }} {% else %} {{ s.username }} {% endif %}</p>
										{% if s.new %}<p><span id="new_message_count" class="right new badge">!</span></p>{% endif %}
								</a>
		    	</li>
					{% endfor %}

		    </ul>

		</div>
		<ul class="sidenav collection" id="slide-out">
			<li id="search_field" class="collection-item l3">

			<div class="row">
					<div class="col s12">
						<div class="row">
							<form  action="{% url 'search' %}" method="GET">
							<div class="input-field col s12">
								<i class="material-icons prefix">search</i>

									<input type="text" id="autocomplete-input" class="autocomplete" name="search">
									<label for="autocomplete-input">Пошук користувача</label>
									<input type="submit" style="display:none;">

							</div>
							</form>
						</div>
					</div>
				</div>

			</li>
			{% for s in sender %}

				{% if s.id == pk %}

				<li class="collection-item avatar l3 tab" style="background-color:red;">
				<a class="hidden_a" href="{% url 'message_user' pk=s.id %}"  style='background-color:#66baf00;' >
					<!-- <span -->
				{% else %}
				{% if recipient.id == s.id %}

					<li class="collection-item avatar l3 tab" style="background-color:greenyellow;">
				{% else %}
				<li class="collection-item avatar l3 tab" >
				{% endif %}
					<a class="hidden_a  l{{ s.id }}" href="{% url 'message_user' pk=s.id %}"  >
				{% endif %}
				<span style="display: none;" class="id" data-id="{{ s.id }}"></span>

					{% load my_tags %}
							<img src="/{% avatar pk=s.pk %}"   alt="" class="circle">
								<p  class="title">{% if s.first_name %}<p>{{ s.first_name }}</p><p> {{ s.last_name }}</p>{% else %} {{ s.username }} {% endif %}</p>

								{% if s.new %}<p><span id="new_message_count" class="right new badge">!</span></p>{% endif %}

						</a>


			</li>
			{% endfor %}

		</ul>
		</nav>

	<!-- Центральна панель -->
 	{% block content %}







 	{% endblock %}
	</div>
</section>



<script src="{% static 'js/dist/bundle.js' %}"></script>
<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>
<!-- materialize_js	 -->
<script src="{% static 'materialize/js/materialize.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/script.js' %}"></script>
<script>
	var loc = window.location;
	var wsStart = 'ws://';
	if (loc.protocol === 'https:'){
		wsStart = 'wss://';
	}
	// var request_user = {{ request.user.id }};
	var endpoint = wsStart + '127.0.0.1:8000/'+ {{ request.user.id }} + '/';
	console.log(endpoint);
	var liveuser_socket = new WebSocket(endpoint);
	console.log(liveuser_socket);
	liveuser_socket.onmessage = function(e){
		console.log('jej');
		var data = JSON.parse(e.data);
		var message = data['message'];
		var user = data['user'];
		console.log(message);
		console.log(message.text);
	$('#chat_window_messages').append('<div class="left_message col m12"><div class="left z-depth-1 col m6"><p class="message_text">'+ message.text+'</p></div></div>');
		console.log('vono proxodit');
		var block = document.getElementById("chat_window_messages");
		block.scrollTop = block.scrollHeight;
		// console.log(JSON.parse(data['json_data'])[0]);
		json_data = JSON.parse(data['json_data']);
		if (json_data){
			console.log(e.data);
			const ids = document.getElementsByClassName('id');
			for (let i = 0; i < ids.length; i++ ) {
				var id = ids[i].getAttribute('data-id');
				var from_user = json_data[0]['fields']['frm_user'];
				// console.log(from_user);
				// console.log(id);
				if (id==from_user){
					console.log('kl');
					$('.l'+id).append('<p><span id="new_message_count" class="right new badge">!</span></p>');
				}


		}
}

}
	liveuser_socket.onopen = function(e){
		console.log('open',e);
	}

	liveuser_socket.onerror = function(e){
		console.log('error',e);
		var liveuser_socket = new WebSocket(endpoint);
	}

	liveuser_socket.onclose = function(e){
		console.log('close',e);
		// var liveuser_socket = new WebSocket(endpoint);
	}






	var messanger_endpoint = wsStart + '127.0.0.1:8000/messanger/'+{{ pk }} + '/' ;
	var messanger_websocket = new WebSocket(messanger_endpoint);
	console.log(messanger_endpoint);




	messanger_websocket.onmessage = function(e){
		var data = JSON.parse(e.data);
    var message = data['message'];
		var user = data['user'];
		console.log({{ request.user.id }});


		console.log('first2');

		var block = document.getElementById("chat_window_messages");
		block.scrollTop = block.scrollHeight;
		console.log('zbc');

	}

	messanger_websocket.onopen = function(e){
		console.log('messanger_open',e);
	}

	messanger_websocket.onerror = function(e){
		console.log('messanger_error',e);
	}

	messanger_websocket.onclose = function(e){
		console.log('messanger_close',e);
	}
	var message;
	$('.message').keyup(function(event){
			console.log(event.keyCode);
			if(event.keyCode === 13){
					event.preventDefault();
					message = $('.message').val();
					console.log(message);
					messanger_websocket.send(message);
					liveuser_socket.send(message);
					$('.message').val('');
					$('#chat_window_messages').append('<div class="right_message col m12"><div class="right z-depth-1 col m6 offset-m6"><p class="message_text">'+ message+'</p></div></div>');
					var block = document.getElementById("chat_window_messages");
					block.scrollTop = block.scrollHeight;

			}
	});
	$('#submit').on('click',function(event){
					message = $('.message').val();
					console.log(message);

					messanger_websocket.send(message);
					liveuser_socket.send(message);
					$('.message').val('');
					console.log('kek');
					$('#chat_window_messages').append('<div class="right_message col m12"><div class="right z-depth-1 col m6 offset-m6"><p class="message_text">'+ message+'</p></div></div>');
					var block = document.getElementById("chat_window_messages");
					block.scrollTop = block.scrollHeight;
					console.log('zbc');
			// }
	});
</script>
</body>
</html>
